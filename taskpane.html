<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>MailPM Taskpane</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      padding: 16px;
      background: #f9f9f9;
    }
    h3 {
      font-size: 16px;
      margin-bottom: 12px;
    }
    select, button {
      font-size: 14px;
      padding: 6px;
      margin-top: 8px;
      width: 100%;
    }
    #status {
      margin-top: 12px;
      color: #555;
    }
  </style>
</head>
<body>
  <h3>進捗管理</h3>
  <label for="progress">進捗状況を選択:</label>
  <select id="progress">
    <option value="未対応">未対応</option>
    <option value="対応中">対応中</option>
    <option value="完了">完了</option>
  </select>
  <button id="insertProgress">本文に反映</button>
  <p id="status"></p>

  <script>
    Office.onReady(async () => {
      document.getElementById("insertProgress").onclick = insertProgress;

      // 現在の本文を読み込み、進捗を自動検出
      Office.context.mailbox.item.body.getAsync("html", (res) => {
        if (res.status === Office.AsyncResultStatus.Succeeded) {
          const html = res.value;
          const match = html.match(/進捗状況:\s*(未対応|対応中|完了)/);
          if (match) {
            document.getElementById("progress").value = match[1];
            document.getElementById("status").innerText = `現在の進捗: ${match[1]}`;
          } else {
            document.getElementById("status").innerText = "進捗情報はまだありません。";
          }
        }
      });
    });

    function insertProgress() {
      const progress = document.getElementById("progress").value;
      const newProgressHTML = `<p><strong>進捗状況:</strong> ${progress}</p>`;

      Office.context.mailbox.item.body.getAsync("html", (res) => {
        if (res.status === Office.AsyncResultStatus.Succeeded) {
          let body = res.value;

          // すでに進捗がある場合は置き換える
          if (body.includes("進捗状況:")) {
            body = body.replace(/進捗状況:\s*(未対応|対応中|完了)/, `進捗状況: ${progress}`);
          } else {
            // なければ末尾に追加
            body += newProgressHTML;
          }

          Office.context.mailbox.item.body.setAsync(body, { coercionType: "html" }, (res2) => {
            if (res2.status === Office.AsyncResultStatus.Succeeded) {
              document.getElementById("status").innerText = `本文に「${progress}」を反映しました。`;
            } else {
              document.getElementById("status").innerText = "本文への反映に失敗しました。";
            }
          });
        }
      });
    }
  </script>
</body>
</html>
