<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>MailPM Auth</title>
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
</head>
<body>
  <h2>MailPM Authentication</h2>
  <button id="login">Microsoftにサインイン</button>

  <script>
    const msalConfig = {
      auth: {
        clientId: "6dab0e8b-444e-4740-9b93-0ec1f350d062",   // Azure ADで取得したクライアントID
        authority: "https://login.microsoftonline.com/c1521ad5-8d23-4d3c-a5c4-e90a535b3c2a",
        redirectUri: "https://shion003-lab.github.io/mail-progress-tracker/auth.html"
      }
    };

    const msalInstance = new msal.PublicClientApplication(msalConfig);

    const loginRequest = {
      scopes: ["User.Read", "Mail.ReadWrite"]
    };

    document.getElementById("login").onclick = async () => {
      try {
        const response = await msalInstance.loginPopup(loginRequest);
        const account = response.account;
        msalInstance.setActiveAccount(account);

        const tokenResponse = await msalInstance.acquireTokenSilent({
          ...loginRequest,
          account
        });

        // トークンを localStorage に保存して taskpane.html から利用可能に
        localStorage.setItem("graph_access_token", tokenResponse.accessToken);
        alert("ログイン成功！これでアドインからGraph APIを利用できます。");
      } catch (err) {
        console.error(err);
        alert("ログインに失敗しました。コンソールを確認してください。");
      }
    };
  </script>
</body>
</html>
